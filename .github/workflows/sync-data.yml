name: Daily Pokemon TCG Data Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC (7 AM BST)

jobs:
  update-pokemon-data:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi

      - name: Create data directory
        run: mkdir -p data

      - name: Fetch Pokemon card data
        run: |
          echo "üé¥ Fetching Pokemon card data..."
          node scripts/fetch-cards.js
          echo "‚úÖ Card data fetch completed"
          ls -la data/

      - name: Process raw cards to cards-all.json
        run: |
          echo "üîÑ Processing raw card data..."
          node -e "
            const fs = require('fs');
            const rawData = JSON.parse(fs.readFileSync('data/raw-cards.json', 'utf8'));
            fs.writeFileSync('data/cards-all.json', JSON.stringify(rawData.cards, null, 2));
            console.log(\`‚úÖ Processed \${rawData.cards.length} cards\`);
          "

      - name: Extract and fix card sets
        run: |
          echo "üîß Extracting card set information..."
          node fix-card-sets.js
          echo "‚úÖ Card sets fixed"

      - name: Fetch comprehensive pricing data
        env:
          TCGCSV_URL: ${{ secrets.TCGCSV_URL }}
        run: |
          echo "üí∞ Fetching comprehensive pricing data..."
          node tcgcsv-scraper.js
          echo "‚úÖ Pricing data scraped"

      - name: Fix fractional pricing keys
        run: |
          echo "üîß Fixing pricing key formats..."
          if [ -f fix-fractional-numbers.js ]; then
            node fix-fractional-numbers.js
          else
            echo "‚ö†Ô∏è  Fractional fix script not found, skipping..."
          fi

      - name: Merge card and pricing data
        run: |
          echo "üîó Merging card and pricing data..."
          node scripts/merge-data.js
          echo "‚úÖ Data merge completed"

      - name: Generate comprehensive summary
        id: summary
        run: |
          echo "üìä Generating update summary..."
          node generate-summary.js
          
          # Read the summary for email
          if [ -f data/update-summary.json ]; then
            echo "summary_file=data/update-summary.json" >> $GITHUB_OUTPUT
          fi

      - name: Upload processed data
        run: |
          echo "‚¨ÜÔ∏è Uploading processed data..."
          node upload-to-github.js
          echo "‚úÖ Data uploaded to GitHub"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Add all data files
          git add data/
          git add summary.json
          
          if git diff --cached --quiet; then
            echo "üìù No changes to commit"
            echo "no_changes=true" >> $GITHUB_ENV
          else
            echo "üìù Committing changes..."
            git commit -m "üîÑ Daily Pokemon TCG data update - $(date -u +%Y-%m-%d)"
            git push
            echo "‚úÖ Changes pushed successfully"
            echo "no_changes=false" >> $GITHUB_ENV
          fi

      - name: Send email notification
        if: env.no_changes == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üé¥ Pokemon TCG Data Updated - $(date +%Y-%m-%d)"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.EMAIL_USERNAME }}
          html_body: file://email-template.html
          attachments: summary.json

      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Pokemon TCG Data Update Failed - $(date +%Y-%m-%d)"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            The daily Pokemon TCG data update failed.
            
            Check the GitHub Actions logs for details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Time: $(date -u)
            Repository: ${{ github.repository }}
            Workflow: ${{ github.workflow }}

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-data-${{ github.run_number }}
          path: |
            data/
            *.log
            *.json
          retention-days: 7
